"use strict";var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},fed=require("frog-event-dispatcher"),Base=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(fed.EventDispatcher);exports.Base=Base;var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},base=require("./Base"),reg=require("./Registry"),ce=require("./event/CollectionEvent"),Collection=function(a){function b(b,c,d,e,f){void 0===c&&(c=null),void 0===d&&(d=!1),void 0===e&&(e=!1),void 0===f&&(f=null),a.call(this),this._tmp1=[],this._tmp2=[],this._readOnly=!1,this._name=b,null!==c?this._entities=c:this._entities=[],this._relayEntityEvents=d,this._readOnly=e,null===f&&(f=reg.Registry.getInstance().getUUIDGenerator().uuid(b)),this._uuid=f,this._relayEntityEvents&&this.length&&this.relayAll(this._entities)}return __extends(b,a),Object.defineProperty(b.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"length",{get:function(){return this._entities.length},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"readOnly",{get:function(){return this._readOnly},enumerable:!0,configurable:!0}),b.prototype.addEntity=function(a,b){return void 0===b&&(b={}),this.hasEntity(a)?!0:(this._tmp1.length=0,this._tmp1.push(a),this.addEntities(this._tmp1,b))},b.prototype.addEntities=function(a,b){void 0===b&&(b={});var c,d,e,f=this._tmp2;for(f.length=0,c=0;c<a.length;c++)this.hasEntity(a[c])||f.push(a[c]);if(0===f.length)return!0;if(this._readOnly)return!1;if(!1!==b&&(e=this.name+this.separator+ce.CollectionEvent.BEFORE_ADD,this.willDispatch(e)&&(d=new ce.CollectionEvent(e,this,f,!0,b),this.dispatch(d),d.isDefaultPrevented)))return!1;for(this._relayEntityEvents&&this.relayAll(f),c=0;c<f.length;c++)this._entities.push(f[c]);return!1!==b&&(e=this.name+this.separator+ce.CollectionEvent.ADDED,this.willDispatch(e)&&(d=new ce.CollectionEvent(e,this,f,!1,b),this.dispatch(d))),!0},b.prototype.hasEntity=function(a){return this.indexOf(a)>-1},b.prototype.indexOf=function(a){return this._entities.indexOf(a)},b.prototype.removeEntity=function(a,b){return void 0===b&&(b={}),this.hasEntity(a)?(this._tmp1.length=0,this._tmp1.push(a),this.removeEntities(this._tmp1,b)):!0},b.prototype.removeEntities=function(a,b){void 0===b&&(b={});var c,d,e,f,g=this._tmp2;for(g.length=0,c=0;c<a.length;c++)this.hasEntity(a[c])&&g.push(a[c]);if(0===g.length)return!0;if(this._readOnly)return!1;if(!1!==b&&(f=this.name+this.separator+ce.CollectionEvent.BEFORE_REMOVE,this.willDispatch(f)&&(e=new ce.CollectionEvent(f,this,g,!0,b),this.dispatch(e),e.isDefaultPrevented)))return!1;for(this._relayEntityEvents&&this.unrelayAll(g),c=0;c<g.length;c++)d=this.indexOf(g[c]),d>-1&&this._entities.splice(d,1);return!1!==b&&(f=this.name+this.separator+ce.CollectionEvent.REMOVED,this.willDispatch(f)&&(e=new ce.CollectionEvent(f,this,g,!1,b),this.dispatch(e))),!0},b.prototype.removeAllEntities=function(a){void 0===a&&(a={});var b,c,d,e=this._tmp2;if(0===this.length)return!0;if(this._readOnly)return!1;for(e.length=0,b=0;b<this._entities.length;b++)e.push(this._entities[b]);return!1!==a&&(d=this.name+this.separator+ce.CollectionEvent.BEFORE_REMOVE,this.willDispatch(d)&&(c=new ce.CollectionEvent(d,this,e,!0,a),this.dispatch(c),c.isDefaultPrevented))?!1:(this._relayEntityEvents&&this.unrelayAll(this._entities),this._entities.length=0,!1!==a&&(d=this.name+this.separator+ce.CollectionEvent.REMOVED,this.willDispatch(d)&&(c=new ce.CollectionEvent(d,this,e,!1,a),this.dispatch(c))),!0)},b}(base.Base);exports.Collection=Collection;var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},base=require("./Base"),reg=require("./Registry"),entityEvent=require("./event/EntityEvent"),relEvent=require("./event/RelationEvent"),Entity=function(a){function b(b,c,d,e,f,g,h,i){void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=!0),void 0===h&&(h=!1),void 0===i&&(i=null),a.call(this),this._name2Field={},this._fieldsNames=[],this._name2Relation={},this._relationsNames=[],this._related={},this._initialState={},this._currentState={},this._tmpFields=[],this._tmpState={},this._tmpStateNew={},this._tmpStateOld={},this._name=b,this._initFields(c,d,f),null!==e&&this._initRelations(e),null===i&&(i=reg.Registry.getInstance().getUUIDGenerator().uuid(b)),this._uuid=i}return __extends(b,a),b.prototype._initFields=function(a,b,c){void 0===c&&(c=null);var d,e,f,g;null===c&&(c=this._tmpState);for(e in a)f=a[e],g=c.hasOwnProperty(e)?c[e]:f.defaultValue,this._name2Field[e]=f,this._fieldsNames.push(e),this._initialState[e]=g;if(b instanceof Array){for(d=0;d<b.length;d++)if(-1===this.fieldsNames.indexOf(b[d]))throw new Error("Primary field "+b[d]+" isn't declared in model: "+this.name);this._primaryNames=b}else{if(-1===this.fieldsNames.indexOf(b))throw new Error("Primary field "+b+" isn't declared in model: "+this.name);this._primaryNames=[b]}},b.prototype._initRelations=function(a){var b,c,d;for(b in a){if(this.fieldsNames.indexOf(b)>-1)throw new Error("Relation "+b+" already declared in field list of model: "+this.name);d=a[b];for(c in d.fieldsMap)if(-1===this.fieldsNames.indexOf(c))throw new Error("Field "+c+" isn't registered in model "+this.name+" for relation "+b);this._name2Relation[b]=d,this._relationsNames.push(b),this._related[b]=null}},Object.defineProperty(b.prototype,"id",{get:function(){var a,b;if(1===this.primaryNames.length)b=this.get(this.primaryNames[0]);else for(b=[],a=0;a<this.primaryNames.length;a++)b.push(this.get(this.primaryNames[a]));return b},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"primaryNames",{get:function(){return this._primaryNames},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"fieldsNames",{get:function(){return this._fieldsNames},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"relationsNames",{get:function(){return this._relationsNames},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"uuid",{get:function(){return this._uuid},enumerable:!0,configurable:!0}),b.prototype.get=function(a,b){if(void 0===b&&(b=!1),!this._name2Field.hasOwnProperty(a))throw new Error("Field don't exist "+a);return!b&&this._currentState.hasOwnProperty(a)?this._currentState[a]:this._initialState[a]},b.prototype.set=function(a,b,c){if(void 0===c&&(c={}),!this._name2Field.hasOwnProperty(a))throw new Error("Field don't exist "+a);var d=this.getState();return d[a]=b,this.setState(d,c)},b.prototype.getState=function(a,b){void 0===a&&(a=!1),void 0===b&&(b=!1);var c;return c=b?{}:this._tmpState,c=this._fillState(c,a)},b.prototype.setState=function(a,b){void 0===b&&(b={});var c,d,e,f,g=this._tmpFields,h=this._fillState(this._tmpStateOld),i=this._fillState(this._tmpStateNew);for(g.length=0,c=0;c<this.fieldsNames.length;c++)d=this.fieldsNames[c],a.hasOwnProperty(d)&&(a[d]=this._name2Field[d].filter(a[d]),a[d]!==i[d]&&(i[d]=a[d],g.push(d)));if(0===g.length)return!0;if(!1!==b&&(f=[entityEvent.EntityEvent.BEFORE_CHANGE,(j={},j[this.name]=[entityEvent.EntityEvent.BEFORE_CHANGE,(k={},k[entityEvent.EntityEvent.BEFORE_CHANGE]=g,k)],j)],this.willDispatch(f)&&(e=new entityEvent.EntityEvent(f,this,g,i,h,!0,b),this.dispatch(e),e.isDefaultPrevented)))return!1;for(c=0;c<g.length;c++)d=g[c],this._initialState[d]===i[d]?this._currentState.hasOwnProperty(d)&&delete this._currentState[d]:this._currentState[d]=i[d];return!1!==b&&(l={},l[this.name]=[entityEvent.EntityEvent.CHANGED,(m={},m[entityEvent.EntityEvent.CHANGED]=g,m)],f=l,this.willDispatch(f)&&(e=new entityEvent.EntityEvent(f,this,g,i,h,!1,b),this.dispatch(e))),!0;var j,k,l,m},b.prototype.getRelation=function(a){return this.hasRelation(a)?this._name2Relation[a]:null},b.prototype.findRelationName=function(a,b){var c,d,e;for(c=0;c<this.relationsNames.length;c++)if(d=this.relationsNames[c],e=this._name2Relation[d],e.entityName===a&&e.type===b)return d;return null},b.prototype.hasRelation=function(a){return this.relationsNames.indexOf(a)>-1},b.prototype.getRelated=function(a){return this.hasRelated(a)?this._related[a]:null},b.prototype.hasRelated=function(a){if(!this.hasRelation(a))throw new Error("Relation with name: "+a+" isn't exist in entity "+this.name);return!!this._related[a]},b.prototype.setRelated=function(a,b,c,d){void 0===c&&(c={}),void 0===d&&(d=!0);var e,f,g=b,h=this.getRelated(a);return this._related[a]===b?!0:!1!==c&&(i={},i[this.name]=[relEvent.RelationEvent.BEFORE_CHANGE,(j={},j[relEvent.RelationEvent.BEFORE_CHANGE]=[a],j)],e=i,this.willDispatch(e)&&(f=new relEvent.RelationEvent(e,this,a,g,h,!0,c),this.dispatch(f),f.isDefaultPrevented))?!1:(this._related[a]=b,!1!==c&&(k={},k[this.name]=[relEvent.RelationEvent.CHANGED,(l={},l[relEvent.RelationEvent.CHANGED]=[a],l)],e=k,this.willDispatch(e)&&(f=new relEvent.RelationEvent(e,this,a,g,h,!1,c),this.dispatch(f))),!0);var i,j,k,l},b.prototype.clear=function(){var a,b;for(a=0;a<this.fieldsNames.length;a++)b=this.fieldsNames[a],this._initialState.hasOwnProperty(b)&&(this._initialState[b]=this._name2Field[b].defaultValue);return this.revert(),this},b.prototype.revert=function(){var a,b;for(a=0;a<this.fieldsNames.length;a++)b=this.fieldsNames[a],this._currentState.hasOwnProperty(b)&&delete this._currentState[b];return this},b.prototype.flush=function(){var a,b;for(a=0;a<this.fieldsNames.length;a++)b=this.fieldsNames[a],this._currentState.hasOwnProperty(b)&&(this._initialState[b]=this._currentState[b]);return this.revert(),this},b.prototype._fillState=function(a,b){void 0===b&&(b=!1);var c,d;for(c=0;c<this.fieldsNames.length;c++)d=this.fieldsNames[c],a[d]=this.get(d,b);return a},b}(base.Base);exports.Entity=Entity;var ugi=require("./UUIDGeneratorImpl"),Registry=function(){function a(){this._uuidGenerator=null}return a.getInstance=function(){return null===a._instance&&(a._instance=new a),a._instance},a.setInstance=function(b){a._instance=b},a.prototype.getUUIDGenerator=function(){return null===this._uuidGenerator&&(this._uuidGenerator=new ugi.UUIDGeneratorImpl),this._uuidGenerator},a.prototype.setUUIDGenerator=function(a){return this._uuidGenerator=a,this},a._instance=null,a}();exports.Registry=Registry,function(a){a[a.BelongsTo=0]="BelongsTo",a[a.HasOne=1]="HasOne",a[a.HasMany=2]="HasMany"}(exports.RelationType||(exports.RelationType={}));var RelationType=exports.RelationType,Relation=function(){function a(a,b,c,d){void 0===d&&(d=!1),this._type=a,this._entityName=b,this._fieldsMap=c,this._relayEvents=d}return Object.defineProperty(a.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"entityName",{get:function(){return this._entityName},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fieldsMap",{get:function(){return this._fieldsMap},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"relayEvents",{get:function(){return this._relayEvents},enumerable:!0,configurable:!0}),a}();exports.Relation=Relation;var UUIDGeneratorImpl=function(){function a(){}return a.prototype.uuid=function(b){return"_"+b+ ++a._sequence},a._sequence=0,a}();exports.UUIDGeneratorImpl=UUIDGeneratorImpl;